

# Сервис OCR для паспортов

Этот проект предоставляет решение для оптического распознавания символов (OCR) на изображениях паспортов. Использует YOLO для детекции полей и EasyOCR для распознавания текста. Извлекает структурированные данные, такие как MRZ, серия и номер, дата рождения и другие поля, поддерживая работу в режимах CLI и сервиса через RabbitMQ и HTTP API.

## Основные возможности

- **Конвейер обработки изображений**: Обнаруживает и извлекает текст из изображений паспортов с помощью YOLO для детекции полей и EasyOCR для распознавания текста.
- **Коррекция ориентации**: Автоматически корректирует ориентацию изображения с помощью тонкой подстройки углов (±1°...±30°) и поворотов на 90° (0°, 90°, 180°, 270°) для точной детекции полей.
- **Нормализация полей**: Нормализует поля, такие как `issued_code` и `issued_by`, используя справочник (`fms_unit.csv`) для согласованности данных.
- **Накопление датасета**: Сохраняет вырезанные изображения полей в датасет (`dataset_for_easyocr`) для последующего дообучения моделей.
- **Гибкий запуск**: Поддерживает CLI-режим для обработки одного файла и сервис-режим с RabbitMQ для масштабируемой обработки задач.
- **Интеграция с API**: Предоставляет HTTP API (`/v1/process`) для отправки изображений в формате base64 и получения структурированных результатов.
- **Обработка ошибок**: Надёжная обработка таймаутов и ошибок (например, некорректное изображение, таймаут, сбои в конвейере).
- **Отладка**: Создаёт отладочные изображения с аннотациями полей в папке `results/`.

## Функциональное описание

Проект обрабатывает изображения паспортов для извлечения структурированных данных через многоэтапный конвейер:

1. **Обработка входных данных**:
   - **Режим CLI**: Обрабатывает один файл (`python main.py path/to/passport.jpg`), сохраняет результаты в `path/to/passport.ocr.json` и отладочные изображения в `results/`.
   - **Сервис-режим**: Слушает очередь RabbitMQ `passport.tasks`, обрабатывает задачи и отправляет ответы в `reply.<correlation_id>` или указанную очередь `reply_to`.
   - **API-режим**: Клиенты отправляют POST-запросы на `/v1/process` с изображением в формате base64 и необязательными параметрами. Сервер API валидирует входные данные, помещает задачу в очередь `passport.tasks` и ждёт ответа до `RPC_TIMEOUT_SEC` (по умолчанию 30 секунд).

2. **Этапы конвейера**:
   - **Этап 1: Тонкая подстройка поворота** (`choose_best_angle_by_sweep`): Проверяет небольшие углы (±1°...±30°) с помощью YOLO, оценивает качество сцены (`scene_score_basic`) и применяет оптимальный поворот.
   - **Этап 1.5: Нормализация** (`normalize_without_mirror`): Если MRZ находится вверху, разворачивает изображение на 180°, чтобы паспорт был в "читаемом" положении.
   - **Этап 2: Выбор поворота на 90°** (`choose_best_k90_layout`): Проверяет повороты на 0°, 90°, 180°, 270°, оценивает компоновку (MRZ снизу, фото слева-снизу и т.д.) и выбирает лучший.
   - **Этап 3: Режим фото** (`choose_best_k90_photo_mode`): Обрабатывает случаи, когда видна только страница с фото, применяя специфические правила компоновки (фото в портретной ориентации, MRZ ниже и т.д.).

3. **Обработка OCR**:
   - Вырезает поля (например, `series_number`, `birth_date`) с расширенными рамками для длинных текстов (`expand_frac`).
   - Применяет предобработку (контраст, адаптивный порог, метод Оцу) и запускает EasyOCR для нескольких вариантов, выбирая лучший текст по уверенности.
   - Выполняет постобработку для очистки текста (удаление лишних пробелов).
   - Для полей ФИО (`fam`, `name`, `sername`) использует словарную коррекцию (`rapidfuzz/levenshtein`) без автозамены, сохраняя кандидатов для UI.
   - Нормализует `issued_code` и `issued_by` с помощью справочника (`fms_unit.csv`), выбирая наиболее подходящее название органа по схожести текста.

4. **Вывод результатов**:
   - **Режим CLI**: Сохраняет JSON-файл (`<input>.ocr.json`) с результатами и отладочные изображения в `results/`.
   - **Сервис-режим**: Отправляет результаты в указанную очередь RabbitMQ в формате:
     ```json
     {
       "status": "ok",
       "result": {
         "image": "<image_b64_or_path>",
         "used_stage": "stage2|stage3",
         "fields": { ... }  // См. пример ответа ниже
       }
     }
     ```
   - При ошибках возвращается `{status: "error", error: "<причина>", detail: "..."}`.

5. **Модули**:
   - `main.py`: Управляет режимами CLI и сервиса, интеграцией с RabbitMQ, запуском конвейера и сохранением результатов.
   - `detection.py`: Выполняет детекцию полей с помощью YOLO.
   - `utils.py`: Содержит базовые операции с изображениями (повороты, кропы, `minAreaRect`, выбор лучшей детекции).
   - `stages.py`: Логика выбора ориентации и компоновки (тонкая подстройка, повороты на 90°, режим фото, отрисовка аннотаций).
   - `ocr.py`: Предобработка, вызов EasyOCR, многовариантное распознавание, сбор уверенности, постобработка.
   - `post_ocr_corrector.py`: Словарная коррекция ФИО без автозамены.
   - `fms_units.py`: Нормализация кода подразделения и сопоставление с органом выдачи.
   - `verifier.py` (опционально): Поддержка LLM для "умной" коррекции.

## Установка и запуск (без контейнера)

### Требования
- **ОС**: Ubuntu 24.04
- **Драйверы**: Установлены драйверы GPU и CUDA 12.*
- **Python**: 3.8+
- **RabbitMQ**: Установлен и запущен с аккаунтом `guest` (пароль: `guest`)

### Установка зависимостей
1. Убедитесь, что все зависимости установлены:
   ```bash
   pip3 install -r requirements.txt
   ```

### Запуск
1. **Запуск RabbitMQ**:
   Убедитесь, что RabbitMQ работает с аккаунтом `guest` и паролем `guest`.

2. **Запуск API-сервера**:
   ```bash
   python3 api_server.py
   ```

3. **Запуск воркера**:
   ```bash
   python3 main.py --service --imgsz 1536 --conf 0.25 --iou 0.6 --device 0
   ```

4. **CLI-режим (для обработки одного файла)**:
   ```bash
   python3 main.py path/to/passport.jpg
   ```

5. **Отправка запросов через API**:
   Отправьте POST-запрос на `http://localhost:8085/v1/process` с телом:
   ```json
   {
     "image_b64": "<base64 файла для распознавания>",
     "meta": {"client": "demo"}
   }
   ```

### Параметры конвейера
- `model`: Путь к YOLO-модели (по умолчанию: `runs/segment/train5/weights/best.pt`).
- `imgsz`, `conf`, `iou`: Параметры детекции YOLO.
- `device`: `"0"` (GPU) или `"cpu"`.
- `dataset_root`: Папка для кропов EasyOCR (`dataset_for_easyocr`).
- `fms_csv`: Путь к справочнику подразделений (`helper_files/fms_unit.csv`).

## Пример ответа API

```json
{
    "request_id": "f44a2b3d-68e3-4cbb-b071-ebeb6a909af9",
    "status": "ok",
    "result": {
        "status": "ok",
        "result": {
            "image": "image_b64",
            "used_stage": "stage3",
            "fields": {
                "mrz": {
                    "value": "'3\" {5 5 #",
                    "confidence": 0.418
                },
                "series_number": {
                    "value": "03 15 810755",
                    "confidence": 1.0
                },
                "birth_date": {
                    "value": "13.04.2001",
                    "confidence": 0.983
                },
                "birth_place": {
                    "value": "ГОРСОЧИ КРАСНОДАРСКОГОКРАЯ",
                    "confidence": 1.0
                },
                "fam": {
                    "value": "БОРЕВ",
                    "confidence": 1.0,
                    "candidates": [
                        ["бореев", 98],
                        ["борнев", 94],
                        ["борцев", 94],
                        ["борчев", 94],
                        ["борщев", 94]
                    ]
                },
                "name": {
                    "value": "ТИМОФЕЙ",
                    "confidence": 0.999,
                    "candidates": [
                        ["тимофей", 100],
                        ["тимафей", 92],
                        ["тим", 90],
                        ["мо", 88],
                        ["ти", 88]
                    ]
                },
                "sername": {
                    "value": "ДАНИИЛОВИЧ",
                    "confidence": 1.0,
                    "candidates": [
                        ["даниилович", 100],
                        ["данилович", 100],
                        ["даниелович", 100],
                        ["даниэлович", 100],
                        ["даниялович", 100]
                    ]
                },
                "sex": {
                    "value": "МУЖ",
                    "confidence": 1.0
                },
                "issued_by": {
                    "value": "",
                    "confidence": null,
                    "dict_meta": {
                        "source": "ocr",
                        "note": "cannot normalize issued_code",
                        "normalized_code": null,
                        "candidates": [],
                        "picked": ""
                    }
                }
            }
        }
    },
    "detail": null
}
```

## Настройка и тюнинг

- **Чувствительность детекции**: Измените параметры `imgsz`, `conf`, `iou` для YOLO.
- **Ширина рамок**: Настройте `expand_frac` в `crop_from_xyxy` для текстовых полей.
- **Порог доверия**: Измените порог для повторных попыток OCR в `process_field_with_retry`.
- **Коррекция ФИО**: Настройте агрессивность подсказок в `post_ocr_corrector.py`.
- **Оценка компоновки**: Тюнинг приоритетов в функциях `scene_score_*` для улучшения ориентации.
- **Пути сохранения**: Измените пути для отладочных изображений (`results/`) и датасета (`dataset_for_easyocr`).

## Отказоустойчивость

- API возвращает `{status: "timeout"}`, если ответ от воркера не получен в течение `RPC_TIMEOUT_SEC` (по умолчанию 30 секунд).
- Воркер логирует исключения и отправляет `{status: "error"}` вместо аварийного завершения.
- Если справочник FMS недоступен, нормализация `issued_by` отключается без прерывания конвейера.

## Лицензия
Apache-2.0 license 
